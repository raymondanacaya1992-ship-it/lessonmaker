<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduQuest | Teacher Power Tools</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- CSS Styles -->
    <style>
        :root {
            --primary: #0077cc;
            --primary-dark: #005fa3;
            --secondary: #28a745;
            --secondary-dark: #1e7e34;
            --danger: #dc3545;
            --warning: #ffc107;
            --background: #f0f4f8;
            --surface: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #dde1e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nunito', sans-serif; }
        body { background-color: var(--background); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

        /* --- Components --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; }
        .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-success { background-color: var(--secondary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: #e6f0fa; }
        .btn-sm { padding: 4px 10px; font-size: 0.85rem; }
        
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; }
        .input { padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; font-size: 1rem; margin-bottom: 10px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        /* --- Header --- */
        header { background: var(--surface); box-shadow: var(--shadow); padding: 15px 0; position: sticky; top: 0; z-index: 100; }
        .nav-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .user-controls { display: flex; gap: 10px; align-items: center; }

        /* --- Views --- */
        .view-section { padding-top: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Landing */
        #view-landing { text-align: center; margin-top: 50px; }
        .subject-cards { display: flex; justify-content: center; gap: 30px; margin-top: 40px; flex-wrap: wrap; }
        .subject-card { width: 300px; height: 200px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; color: white; border-radius: 20px; cursor: pointer; transition: transform 0.2s; }
        .subject-math { background: linear-gradient(135deg, #0077cc, #00a3ff); }
        .subject-science { background: linear-gradient(135deg, #28a745, #5ddc79); }
        .subject-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }

        /* Library */
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .game-card { cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; height: 100%; position: relative; }
        .game-card:hover { border-color: var(--primary); }
        .badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #555; }
        .badge-assigned { background: var(--warning); color: #555; font-weight: bold; }
        
        .admin-delete-btn { 
            position: absolute; top: -10px; right: -10px; 
            background: var(--danger); border: 2px solid white; border-radius: 50%; 
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; 
            color: white; z-index: 20; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .admin-delete-btn:hover { background: #bd2130; transform: scale(1.1); }

        /* Game Player */
        #game-frame { width: 100%; height: 75vh; border: none; border-radius: var(--radius); background: white; box-shadow: var(--shadow); }
        .unsaved-dot { width: 10px; height: 10px; background-color: var(--danger); border-radius: 50%; display: inline-block; margin-right: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Dashboard Tabs */
        .tabs { display: flex; gap: 10px; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { color: var(--text-light); font-size: 0.9rem; background: #fafafa; }
        .table-container { overflow-x: auto; }

        /* Utils */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; transform: translateY(-10px); }
        textarea { height: 150px; font-family: monospace; }
        
        /* Assignment Selection */
        .assignment-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .assignment-row:last-child { border-bottom: none; }
        .checkbox-custom { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="container nav-wrapper">
            <div class="logo" onclick="app.router.go('landing')">
                <span>üéì EduQuest</span>
            </div>
            <div class="user-controls" id="header-controls"></div>
        </div>
    </header>

    <main class="container">
        <div id="main-spinner" class="spinner"></div>

        <!-- VIEW: Landing -->
        <div id="view-landing" class="view-section">
            <h1>Welcome to EduQuest</h1>
            <p style="color: var(--text-light);">Select a subject to start.</p>
            <div class="subject-cards">
                <div class="subject-card subject-math" onclick="app.logic.selectSubject('math')">üßÆ Math</div>
                <div class="subject-card subject-science" onclick="app.logic.selectSubject('science')">üß¨ Science</div>
            </div>
            <div id="admin-entry" class="hidden" style="margin-top:40px; text-align:center;">
                <button class="btn btn-secondary btn-sm" onclick="app.router.go('admin')">Admin Panel</button>
            </div>
        </div>

        <!-- VIEW: Library -->
        <div id="view-library" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn btn-outline" onclick="app.router.go('landing')">‚Üê Back to Subjects</button>
                <button class="btn btn-secondary btn-sm" onclick="app.logic.refreshContent()">üîÑ Refresh Content</button>
            </div>
            <div class="card filters-bar">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <input type="text" id="filter-search" class="input" placeholder="Search..." oninput="app.logic.renderLibrary()">
                    <select id="filter-grade" class="input" onchange="app.logic.renderLibrary()">
                        <option value="">All Grades</option>
                        <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                    <select id="filter-topic" class="input" onchange="app.logic.renderLibrary()">
                        <option value="">All Topics</option>
                    </select>
                </div>
            </div>
            <div id="library-grid" class="games-grid"></div>
        </div>

        <!-- VIEW: Game Player -->
        <div id="view-game" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <button class="btn btn-outline" onclick="app.logic.exitGame()">‚Üê Save & Exit</button>
                <div style="text-align: center;">
                    <span id="game-player-title" style="font-weight: bold; display:block;"></span>
                    <span id="unsaved-indicator" style="font-size: 0.8rem; color: var(--danger); display:none;">
                        <span class="unsaved-dot"></span> Unsaved Changes
                    </span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="game-current-score" class="badge" style="font-size: 1rem;">Score: 0</span>
                    <button class="btn btn-success" onclick="app.logic.saveScoreManual()">üíæ Save</button>
                </div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
        </div>

        <!-- VIEW: Teacher Dashboard -->
        <div id="view-dashboard" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')">Back to Home</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="app.dashboard.switchTab('class')">Manage Class</button>
                <button class="tab-btn" onclick="app.dashboard.switchTab('assign')">Assignments</button>
                <button class="tab-btn" onclick="app.dashboard.switchTab('grades')">Gradebook</button>
            </div>
            
            <!-- Tab 1: Manage Class -->
            <div id="tab-class" class="dashboard-tab">
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Add Student</h3>
                        <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">Single Add:</p>
                        <div style="display:flex; gap:5px; margin-bottom:15px;">
                            <input type="text" id="new-student-name" class="input" placeholder="Full Name" style="margin-bottom:0;">
                            <button class="btn btn-primary btn-sm" onclick="app.dashboard.createStudent()">Add</button>
                        </div>
                        <div id="new-student-result" style="margin-bottom:15px; color: var(--primary); font-weight:bold;"></div>
                        
                        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                        
                        <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">Bulk Upload (CSV):</p>
                        <p style="font-size:0.75rem; color:#888; margin-bottom:5px;">List names in column A or separated by commas.</p>
                        <input type="file" id="csv-upload" accept=".csv" style="font-size:0.8rem;">
                        <button class="btn btn-secondary btn-sm" style="margin-top:5px; width:100%;" onclick="app.dashboard.handleCSVUpload()">Upload Class List</button>
                    </div>
                    <div class="card table-container">
                        <h3>Student List</h3>
                        <table><thead><tr><th>Name</th><th>Login Code</th><th>Actions</th></tr></thead><tbody id="student-list-body"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Assignments (UPDATED) -->
            <div id="tab-assign" class="dashboard-tab hidden">
                <div class="card">
                    <h3>Assign Lesson</h3>
                    
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold;">1. Select Subject</label>
                            <select id="assign-subject" class="input" style="margin-bottom:0;" onchange="app.dashboard.loadAssignableGames()"><option value="math">Math</option><option value="science">Science</option></select>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold;">2. Select Game</label>
                            <select id="assign-game" class="input" style="margin-bottom:0;"><option value="">Select a Game...</option></select>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0;">3. Select Students</h4>
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleSelectAll(true)">Select All</button>
                            <button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleSelectAll(false)">Deselect All</button>
                        </div>
                    </div>

                    <div id="assign-student-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; margin-bottom:20px;">
                        <!-- Checkboxes injected here -->
                    </div>

                    <button class="btn btn-primary" style="width:100%;" onclick="app.dashboard.assignGameToSelected()">Assign to Selected Students</button>
                </div>
            </div>

            <!-- Tab 3: Grades -->
            <div id="tab-grades" class="dashboard-tab hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Class Performance</h3>
                        <button class="btn btn-secondary btn-sm" onclick="app.dashboard.exportCSV()">Download CSV üì•</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div>
                            <label style="font-size: 0.8rem; font-weight: bold; color: #666;">Filter by Grade</label>
                            <select id="gb-filter-grade" class="input" style="margin-bottom:0;" onchange="app.dashboard.filterGradebook()">
                                <option value="">All Grades</option>
                                <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: bold; color: #666;">Filter by Subject</label>
                            <select id="gb-filter-subject" class="input" style="margin-bottom:0;" onchange="app.dashboard.filterGradebook()">
                                <option value="">All Subjects</option>
                                <option value="math">Math</option>
                                <option value="science">Science</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: bold; color: #666;">Filter by Game</label>
                            <select id="gb-filter-game" class="input" style="margin-bottom:0;" onchange="app.dashboard.renderGradebookTable()">
                                <option value="">All Games</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-container">
                        <table><thead><tr><th>Student</th><th>Game Title</th><th>Score</th><th>Questions</th><th>Correct</th><th>Date</th></tr></thead><tbody id="gradebook-body"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: Logins -->
        <div id="view-teacher-login" class="view-section hidden">
            <div class="card" style="max-width:400px; margin:50px auto; text-align:center;">
                <h2>Teacher Login</h2>
                <button class="btn btn-primary" onclick="app.auth.loginTeacher()" style="margin-top:20px;">Sign in with Google</button>
                <div style="margin:20px; color:#aaa;">- OR -</div>
                <button class="btn btn-outline" onclick="app.router.go('student-login')">Student Login</button>
            </div>
        </div>
        <div id="view-student-login" class="view-section hidden">
            <div class="card" style="max-width:400px; margin:50px auto; text-align:center;">
                <h2>Student Access</h2>
                <input type="text" id="student-login-code" class="input" placeholder="e.g. alex-123">
                <button class="btn btn-secondary" onclick="app.auth.loginStudent()">Enter Classroom</button>
                <div style="margin-top:20px;">
                    <button class="btn btn-sm btn-outline" onclick="app.router.go('landing')">Cancel</button>
                    <br><br><a href="#" style="font-size:0.8rem;" onclick="app.router.go('teacher-login')">Are you a Teacher?</a>
                </div>
            </div>
        </div>

        <!-- VIEW: Admin -->
        <div id="view-admin" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Admin Panel</h2>
                <button class="btn btn-outline" onclick="app.router.go('landing')">Exit Admin</button>
            </div>
            <div class="card" id="admin-form" style="margin-top:20px;">
                <h3>Create New Lesson</h3>
                <input type="text" id="admin-title" class="input" placeholder="Title">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="admin-subject" class="input"><option value="math">Math</option><option value="science">Science</option></select>
                    <select id="admin-grade" class="input"><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                </div>
                <input type="text" id="admin-topic" class="input" placeholder="Topic">
                <textarea id="admin-html" class="input" placeholder="Paste HTML Code here..."></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="app.logic.addGame()">Save Lesson</button>
                    <button class="btn btn-outline" onclick="app.logic.fillSampleGame()">Prefill Sample</button>
                </div>
            </div>
        </div>
    </main>
    <div id="toast" class="toast">Action Successful</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, setDoc, deleteDoc, onSnapshot, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCYVPsTnfNnyYfmgyKqeTtIAg5qf-ganS4",
            authDomain: "visualizationpractice.firebaseapp.com",
            projectId: "visualizationpractice",
            storageBucket: "visualizationpractice.firebasestorage.app",
            messagingSenderId: "814840211812",
            appId: "1:814840211812:web:01543de18dc9cb3ce23271"
        };
        const ADMIN_EMAIL = "raymond.anacaya1992@gmail.com";
        let db, auth;
        const appInstance = initializeApp(firebaseConfig);
        db = getFirestore(appInstance);
        auth = getAuth(appInstance);

        const state = { userType: null, currentUser: null, studentId: null, selectedSubject: null, games: [], students: [], currentGameId: null, pendingScore: null, allGamesMap: {} };
        const ui = {
            spinner: (show) => document.getElementById('main-spinner').style.display = show ? 'block' : 'none',
            toast: (msg) => { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); },
            showAdminEntry: (show) => { const el = document.getElementById('admin-entry'); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); },
            toggleUnsavedIndicator: (show) => { document.getElementById('unsaved-indicator').style.display = show ? 'inline-block' : 'none'; }
        };
        const router = {
            go: (viewId) => {
                if(viewId === 'admin') { if(prompt("Enter Admin Password:") !== "1030") return alert("Access Denied"); }
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                // --- FIX: AUTO LOAD DATA ON DASHBOARD ENTRY ---
                if(viewId === 'dashboard') {
                    // Automatically load the active tab's data
                    const activeTab = document.querySelector('.tab-btn.active');
                    if(activeTab) {
                        if(activeTab.innerText.includes('Manage')) dashboard.loadStudents();
                        else if(activeTab.innerText.includes('Assign')) dashboard.loadAssignableGames(); // and students
                        else dashboard.loadGrades();
                    } else {
                        // Default to class tab if none active
                        dashboard.switchTab('class'); 
                    }
                }
                
                updateHeader(); window.scrollTo(0,0);
            }
        };
        const authService = {
            loginTeacher: async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { alert(e.message); } },
            loginStudent: async () => {
                const code = document.getElementById('student-login-code').value.trim(); if(!code) return;
                ui.spinner(true);
                const snap = await getDocs(query(collection(db, "students"), where("loginCode", "==", code)));
                if (snap.empty) { alert("Invalid Code"); ui.spinner(false); return; }
                const d = snap.docs[0]; state.userType = 'student'; state.currentUser = d.data(); state.studentId = d.id; localStorage.setItem('edu_student_id', d.id); router.go('landing'); ui.spinner(false);
            },
            logout: async () => { if (state.userType === 'teacher') await signOut(auth); state.userType = null; state.currentUser = null; state.studentId = null; localStorage.removeItem('edu_student_id'); router.go('landing'); },
            check: () => {
                onAuthStateChanged(auth, (user) => {
                    if (user) { 
                        state.userType = 'teacher'; 
                        state.currentUser = user; 
                        ui.showAdminEntry(user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()); 
                        // --- FIX: AUTO REDIRECT TO DASHBOARD ---
                        const currentView = document.querySelector('.view-section:not(.hidden)').id;
                        if(currentView === 'view-teacher-login' || currentView === 'view-landing') {
                             router.go('dashboard');
                        }
                    } else {
                        ui.showAdminEntry(false);
                    }
                    updateHeader();
                });
                const sid = localStorage.getItem('edu_student_id');
                if(sid && !state.userType) onSnapshot(doc(db, "students", sid), (doc) => { if(doc.exists()) { state.userType = 'student'; state.currentUser = doc.data(); state.studentId = doc.id; updateHeader(); } });
            }
        };
        const dashboard = {
            switchTab: (tabName) => { document.querySelectorAll('.dashboard-tab').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.remove('hidden'); document.querySelector(`button[onclick="app.dashboard.switchTab('${tabName}')"]`).classList.add('active'); if(tabName === 'class') dashboard.loadStudents(); if(tabName === 'assign') { dashboard.loadAssignableGames(); dashboard.loadStudentsForAssignment(); } if(tabName === 'grades') dashboard.loadGrades(); },
            
            // --- CSV UPLOAD FEATURE ---
            handleCSVUpload: () => {
                const fileInput = document.getElementById('csv-upload');
                const file = fileInput.files[0];
                if (!file) return alert("Please select a CSV file first.");

                const reader = new FileReader();
                reader.onload = async function(e) {
                    const text = e.target.result;
                    // Split by new line, remove empty lines
                    const names = text.split('\n').map(n => n.trim()).filter(n => n.length > 0);
                    
                    if (names.length === 0) return alert("File is empty");
                    if (names.length > 50) return alert("Limit 50 students per upload.");

                    ui.spinner(true);
                    const batch = writeBatch(db);
                    let count = 0;

                    for (const name of names) {
                        // Skip header if present (heuristic: "Name" or "name")
                        if(name.toLowerCase() === 'name') continue;

                        const code = name.split(' ')[0].toLowerCase().replace(/[^a-z0-9]/g, '') + '-' + Math.floor(Math.random()*1000);
                        const ref = doc(collection(db, "students"));
                        batch.set(ref, {
                            name: name, 
                            loginCode: code, 
                            teacherId: state.currentUser.uid, 
                            scores: {}, 
                            assignments: []
                        });
                        count++;
                    }

                    try {
                        await batch.commit();
                        ui.toast(`Successfully created ${count} students!`);
                        dashboard.loadStudents();
                        fileInput.value = ''; // Reset
                    } catch (err) {
                        alert("Error uploading: " + err.message);
                    }
                    ui.spinner(false);
                };
                reader.readAsText(file);
            },

            createStudent: async () => { const name = document.getElementById('new-student-name').value.trim(); if(!name) return; const code = name.split(' ')[0].toLowerCase().replace(/[^a-z0-9]/g, '') + '-' + Math.floor(Math.random()*1000); await addDoc(collection(db, "students"), { name, loginCode: code, teacherId: state.currentUser.uid, scores: {}, assignments: [] }); document.getElementById('new-student-name').value = ''; document.getElementById('new-student-result').textContent = `Code: ${code}`; dashboard.loadStudents(); },
            loadStudents: async () => { const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid))); state.students = snap.docs.map(d => ({id: d.id, ...d.data()})); document.getElementById('student-list-body').innerHTML = state.students.map(s => `<tr><td>${s.name}</td><td><code>${s.loginCode}</code></td><td><button class="btn btn-danger btn-sm" onclick="app.dashboard.deleteStudent('${s.id}')">Delete</button></td></tr>`).join(''); },
            deleteStudent: async (id) => { if(confirm("Delete student?")) { await deleteDoc(doc(db, "students", id)); dashboard.loadStudents(); } },
            loadAssignableGames: async () => { const subj = document.getElementById('assign-subject').value; const snap = await getDocs(query(collection(db, "games"), where("subject", "==", subj))); const select = document.getElementById('assign-game'); select.innerHTML = '<option value="">Select a Game...</option>'; snap.forEach(d => select.innerHTML += `<option value="${d.data().gameId}">${d.data().title}</option>`); },
            
            // --- ASSIGNMENT UPGRADES ---
            loadStudentsForAssignment: async () => {
                // Ensure students are loaded
                if(state.students.length === 0) await dashboard.loadStudents();
                const list = document.getElementById('assign-student-list');
                list.innerHTML = state.students.map(s => `
                    <div class="assignment-row">
                        <input type="checkbox" class="checkbox-custom student-select-cb" value="${s.id}" checked>
                        <span>${s.name}</span>
                    </div>
                `).join('');
            },
            toggleSelectAll: (select) => {
                document.querySelectorAll('.student-select-cb').forEach(cb => cb.checked = select);
            },
            assignGameToSelected: async () => {
                const gameId = document.getElementById('assign-game').value;
                if(!gameId) return alert("Select a game");
                
                // Get selected IDs
                const selectedIds = Array.from(document.querySelectorAll('.student-select-cb:checked')).map(cb => cb.value);
                if(selectedIds.length === 0) return alert("Select at least one student");

                ui.spinner(true);
                const batch = writeBatch(db);
                selectedIds.forEach(id => {
                    const ref = doc(db, "students", id);
                    // Firestore doesn't support arrayUnion in batch directly with helper, need specific update call syntax
                    // But we can do Promise.all for updates since it's cleaner for arrayUnion
                });

                // Batch write doesn't support arrayUnion easily in modular SDK mixed with set, using Promise.all
                const updates = selectedIds.map(id => updateDoc(doc(db, "students", id), { assignments: arrayUnion(gameId) }));
                
                await Promise.all(updates);
                ui.spinner(false);
                ui.toast(`Assigned to ${selectedIds.length} students!`);
            },

            loadGrades: async () => {
                await dashboard.loadStudents();
                // Fetch ALL games to cache metadata for dropdowns
                const gameSnap = await getDocs(collection(db, "games"));
                state.allGamesMap = {};
                gameSnap.forEach(d => state.allGamesMap[d.data().gameId] = d.data());
                
                dashboard.filterGradebook();
            },

            filterGradebook: () => {
                const gradeFilter = document.getElementById('gb-filter-grade').value;
                const subjectFilter = document.getElementById('gb-filter-subject').value;
                const gameSelect = document.getElementById('gb-filter-game');
                
                let optionsHtml = '<option value="">All Games</option>';
                Object.values(state.allGamesMap).forEach(g => {
                    const matchGrade = !gradeFilter || g.grade === gradeFilter;
                    const matchSubject = !subjectFilter || g.subject === subjectFilter;
                    if(matchGrade && matchSubject) {
                        optionsHtml += `<option value="${g.gameId}">${g.title}</option>`;
                    }
                });
                const currentVal = gameSelect.value;
                gameSelect.innerHTML = optionsHtml;
                if(currentVal && gameSelect.querySelector(`option[value="${currentVal}"]`)) {
                     gameSelect.value = currentVal;
                }
                dashboard.renderGradebookTable();
            },

            renderGradebookTable: () => {
                const gradeFilter = document.getElementById('gb-filter-grade').value;
                const subjectFilter = document.getElementById('gb-filter-subject').value;
                const gameFilter = document.getElementById('gb-filter-game').value;
                
                const tbody = document.getElementById('gradebook-body');
                tbody.innerHTML = '';
                
                state.students.forEach(s => {
                    if(!s.scores) return;
                    Object.keys(s.scores).forEach(gameId => {
                        const gameMeta = state.allGamesMap[gameId];
                        if(!gameMeta) return;

                        const matchGrade = !gradeFilter || gameMeta.grade === gradeFilter;
                        const matchSubject = !subjectFilter || gameMeta.subject === subjectFilter;
                        const matchGame = !gameFilter || gameId === gameFilter;

                        if (matchGrade && matchSubject && matchGame) {
                            const data = s.scores[gameId];
                            const scoreVal = typeof data === 'object' ? data.score : data;
                            tbody.innerHTML += `<tr><td>${s.name}</td><td>${gameMeta.title}</td><td><b>${scoreVal}</b></td><td>${data.total||'-'}</td><td>${data.correct||'-'}</td><td>${data.date ? new Date(data.date).toLocaleDateString() : '-'}</td></tr>`;
                        }
                    });
                });
            },
            
            exportCSV: () => { const rows = [["Student Name", "Game ID", "Score", "Total", "Correct", "Date"]]; state.students.forEach(s => { if(s.scores) Object.keys(s.scores).forEach(gid => { const d = s.scores[gid]; rows.push([s.name, gid, d.score||d, d.total||'', d.correct||'', d.date||'']); }); }); const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n")); link.download = "gradebook.csv"; document.body.appendChild(link); link.click(); }
        };

        const logic = {
            selectSubject: async (subj) => {
                if (!state.currentUser) { router.go('student-login'); return; }
                state.selectedSubject = subj; ui.spinner(true);
                const cacheKey = `edu_cache_${subj}`; const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) { state.games = JSON.parse(cachedData); logic.renderLibrary(); router.go('library'); ui.spinner(false); }
                else { const snap = await getDocs(query(collection(db, "games"), where("subject", "==", subj))); state.games = snap.docs.map(d => ({ docId: d.id, ...d.data() })); localStorage.setItem(cacheKey, JSON.stringify(state.games)); logic.renderLibrary(); router.go('library'); ui.spinner(false); }
            },
            refreshContent: () => { localStorage.removeItem(`edu_cache_${state.selectedSubject}`); logic.selectSubject(state.selectedSubject); },
            renderLibrary: () => {
                const grid = document.getElementById('library-grid'); grid.innerHTML = '';
                const search = document.getElementById('filter-search').value.toLowerCase();
                const grade = document.getElementById('filter-grade').value;
                const topic = document.getElementById('filter-topic').value;
                const topics = [...new Set(state.games.map(g => g.topic))]; const ts = document.getElementById('filter-topic'); if(ts.options.length === 1) topics.forEach(t => ts.innerHTML += `<option value="${t}">${t}</option>`);
                let filtered = state.games.filter(g => (g.title.toLowerCase().includes(search) || g.topic.toLowerCase().includes(search)) && (!grade || g.grade === grade) && (!topic || (document.getElementById('filter-topic').value ? g.topic === document.getElementById('filter-topic').value : true)));
                const assignments = (state.userType === 'student' && state.currentUser.assignments) ? state.currentUser.assignments : []; filtered.sort((a,b) => (assignments.includes(b.gameId) - assignments.includes(a.gameId)));
                const isAdmin = state.currentUser?.email && (state.currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
                if(filtered.length === 0) grid.innerHTML = "<p>No lessons found locally. Try Refreshing Content.</p>";
                filtered.forEach(g => { const isAssigned = assignments.includes(g.gameId); const el = document.createElement('div'); el.className = 'card game-card'; el.innerHTML = `${isAdmin ? `<div class="admin-delete-btn" title="Delete Lesson" onclick="event.stopPropagation(); app.logic.deleteGame('${g.docId}')">‚úï</div>` : ''}<div><h3>${g.title}</h3><div class="game-badges"><span class="badge">Grade ${g.grade}</span><span class="badge">${g.topic}</span>${isAssigned ? '<span class="badge badge-assigned">‚≠ê Assigned</span>' : ''}</div></div><div style="margin-top:15px; text-align:right;"><button class="btn btn-primary btn-sm">Play ‚ñ∂</button></div>`; el.onclick = () => logic.launchGame(g); grid.appendChild(el); });
            },
            launchGame: (game) => {
                state.currentGameId = game.gameId;
                state.pendingScore = null;
                ui.toggleUnsavedIndicator(false);
                document.getElementById('game-player-title').textContent = game.title;
                let savedScore = 0;
                if (state.currentUser && state.currentUser.scores && state.currentUser.scores[game.gameId]) {
                    const data = state.currentUser.scores[game.gameId];
                    savedScore = (typeof data === 'object') ? (data.score || 0) : data;
                }
                const iframe = document.getElementById('game-frame');
                const scoreScript = `<script>window.INITIAL_SCORE = ${savedScore};<\/script>`;
                iframe.srcdoc = scoreScript + game.htmlCode;
                router.go('game');
            },
            handleScoreUpdate: (data) => {
                if(state.userType !== 'student') return;
                state.pendingScore = { score: data.score, total: data.total || 0, correct: data.correct || 0, date: new Date().toISOString() };
                document.getElementById('game-current-score').textContent = `Score: ${data.score}`;
                ui.toggleUnsavedIndicator(true);
            },
            saveScoreManual: async () => {
                if(!state.pendingScore || !state.studentId) return;
                ui.spinner(true);
                try { await updateDoc(doc(db, "students", state.studentId), { [`scores.${state.currentGameId}`]: state.pendingScore }); ui.toast("Progress Saved to Cloud! ‚òÅÔ∏è"); ui.toggleUnsavedIndicator(false); state.pendingScore = null; } catch(e) { alert("Save failed. Check internet."); }
                ui.spinner(false);
            },
            exitGame: async () => { if(state.pendingScore) { if(confirm("You have unsaved progress. Save before exiting?")) await logic.saveScoreManual(); } router.go('library'); },
            addGame: async () => {
                const title = document.getElementById('admin-title').value; const html = document.getElementById('admin-html').value; if(!title || !html) return alert("Missing fields");
                await setDoc(doc(db, "games", 'game_'+Date.now()), { gameId: 'game_'+Date.now(), title, subject: document.getElementById('admin-subject').value, grade: document.getElementById('admin-grade').value, topic: document.getElementById('admin-topic').value, htmlCode: html, createdAt: new Date() });
                localStorage.removeItem(`edu_cache_${document.getElementById('admin-subject').value}`); ui.toast("Lesson Added");
            },
            deleteGame: async (docId) => { if(confirm("Admin: Delete this lesson?")) { await deleteDoc(doc(db, "games", docId)); localStorage.removeItem(`edu_cache_${state.selectedSubject}`); ui.toast("Deleted"); logic.selectSubject(state.selectedSubject); } },
            fillSampleGame: () => {
                document.getElementById('admin-title').value = "Super Math Quiz";
                document.getElementById('admin-html').value = `<h3>What is 10 + 10?</h3><button onclick="ans(20)">20</button> <button onclick="ans(30)">30</button><script>function ans(val) { if(val===20) { alert('Correct! Unsaved changes pending...'); window.parent.postMessage({type:'TOOL_SCORE', score:100, total:1, correct:1}, '*'); } else { alert('Wrong'); window.parent.postMessage({type:'TOOL_SCORE', score:0, total:1, correct:0}, '*'); } }<\/script>`.trim();
            }
        };

        function updateHeader() {
            const h = document.getElementById('header-controls');
            if(!state.userType) h.innerHTML = `<button class="btn btn-outline btn-sm" onclick="app.router.go('teacher-login')">Teacher Login</button><button class="btn btn-primary btn-sm" onclick="app.router.go('student-login')">Student Login</button>`;
            else if(state.userType === 'student') h.innerHTML = `<span style="font-weight:bold; margin-right:10px;">Hi, ${state.currentUser.name}</span><button class="btn btn-outline btn-sm" onclick="app.auth.logout()">Sign Out</button>`;
            else if(state.userType === 'teacher') h.innerHTML = `<button class="btn btn-primary btn-sm" onclick="app.router.go('dashboard')">Dashboard</button><button class="btn btn-outline btn-sm" onclick="app.auth.logout()">Sign Out</button>`;
        }
        window.addEventListener('message', (e) => { if(e.data && e.data.type === 'TOOL_SCORE') logic.handleScoreUpdate(e.data); });
        authService.check(); window.app = { router, logic, auth: authService, dashboard };
    </script>
</body>
</html>
